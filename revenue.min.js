!function(){"use strict";function e(e){"string"==typeof e&&(localStorage.optly_transactions="undefined"==typeof localStorage.optly_transactions?"/"+e+"/":localStorage.optly_transactions+e+"/")}function n(e){return"undefined"==typeof localStorage.optly_transactions||-1==localStorage.optly_transactions.indexOf("/"+e+"/")?!1:!0}function o(e,n,o){var r=e+"_"+n;l("Setting conversion rate for "+r+" to "+o),isNaN(o)||sessionStorage.setItem(r,o)}function r(e,n){var o=e+"_"+n;return sessionStorage.getItem(o)}function t(e,n){isNaN(e)?f("Invalid Revenue "+e):window.optimizely.push(["trackEvent",n,{revenue:e}])}function i(e){for(var n in e)window.optimizely.push(["setDimensionValue",n,e[n]])}function a(e){setTimeout(function(){for(var n in e)window.optimizely.push(["setDimensionValue",n])},3e3)}function s(e,n,o,r,t){var i;l("CORS request "+e),XMLHttpRequest?(i=new XMLHttpRequest,"withCredentials"in i&&(i.open(n,e,!0),i.onerror=t,i.onreadystatechange=function(){4===i.readyState&&(i.status>=200&&i.status<400?r(o,i.responseText):t(o,new Error("Response returned with non-OK status")))},i.send(null))):XDomainRequest?(i=new XDomainRequest,i.open(n,e),i.onerror=t,i.onload=function(){r(o,i.responseText)},i.send(null)):t(o,new Error("CORS not supported"))}function u(e,n){if("fixerio"==e.vendor){var r=JSON.parse(n).rates;for(var i in r)if(i==y){l("[Fixerio] Exchange rate is "+r[i]),o(e.currency,y,r[i]);var a=(e.revenueInCents*r[i]).toFixed(0);t(a,e.eventName)}}else if("yahoo"==e.vendor){l("[Yahoo] Exchange rate is "+JSON.parse(n).query.results.row.rate),o(e.currency,y,JSON.parse(n).query.results.row.rate);var a=(e.revenueInCents*JSON.parse(n).query.results.row.rate).toFixed(0);t(a,e.eventName)}else f("Unknow vendor on success")}function c(e,n){"undefined"!=typeof e.vendor&&("fixerio"==e.vendor?(f("Currency convertion error for vendor Fixerio. Falling back to Yahoo"),e.vendor="yahoo",s("https://query.yahooapis.com/v1/public/yql?q=select%20rate%2Cname%20from%20csv%20where%20url%3D'http%3A%2F%2Fdownload.finance.yahoo.com%2Fd%2Fquotes%3Fs%3D"+e.currency+y+"%253DX%26f%3Dl1n'%20and%20columns%3D'rate%2Cname'&format=json","get",e,u,c)):"yahoo"==e.vendor?(f("Currency convertion error for vendor Yahoo. No fallback"),window.optimizely.push(["trackEvent","error "+e.revenueInCents+e.currency])):f("Currency convertion error for vendor "+e.vendor+" :"+n))}function d(e,n,o){var i=r(o,y);null===i?s("http://api.fixer.io/latest?base="+o,"get",{vendor:"fixerio",currency:o,eventName:n,revenueInCents:e},u,c):(l("Using stored convertion rate "+i),e=(e*i).toFixed(0),t(e,n))}function f(e){console.error(e)}function l(e){v===!0&&console.log(e)}function p(e){for(var n in e)e.hasOwnProperty(n)&&!optimizely.hasOwnProperty(n)&&(optimizely[n]=e[n])}var v=!0,y="USD",m="purchase",w={trackRevenue:function(o,r){l("New revenue "+o),"undefined"==typeof r&&(r={});var s=r.id,u=r.currency;"undefined"!=typeof r.to_currency&&(y=r.to_currency),"undefined"!=typeof r.event_name&&(m=r.event_name);var c=m+("undefined"==typeof s?"":" "+s);window.optimizely=window.optimizely||[],i(r.dimensions),"undefined"!=typeof s&&n(s)?l("Not sending duplicated revenue"):("undefined"!=typeof s&&e(s),"undefined"!=typeof u?(d(o,c,u),a(r.dimensions)):(t(o,c),a(r.dimensions)))}},h=setInterval(function(){"object"==typeof optimizely&&(clearInterval(h),p(w))},50)}();